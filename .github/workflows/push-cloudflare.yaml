name: Build

on:
    push:
        branches: [main, uat, release*]
    pull_request_target:
        branches: [main, uat, release*]
    workflow_dispatch:

jobs:
    build:
        name: Run production build
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            # 安装 Rust 工具链
            - run: rustup toolchain install stable --profile minimal
            - run: rustup target add wasm32-unknown-unknown
            - name: Install lld
              run: sudo apt install -y lld clang gcc llvm

            # 安装 worker-build 作为全局工具
            - name: Install worker-build
              run: cargo install --locked worker-build

            # 使用全局安装的 worker-build 工具构建 WASM 模块
            - name: Build WASM module
              run: worker-build --release

            # 替换 D1_DATABASE_ID in wrangler.toml
            - name: Replace D1_DATABASE_ID in wrangler.toml
              run: sed -i "s/\${D1_DATABASE_ID}/${{ secrets.D1_DATABASE_ID }}/g" wrangler.toml

            # 运行 Wrangler Action，添加明确命令和详细日志
            - uses: cloudflare/wrangler-action@v3
              id: cf
              env:
                  D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  command: deploy
                  verbosity: verbose
